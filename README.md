<h1 align="center">GOONO SERVER</h1>

[![Build Status](https://jenkins.redwit.io/buildStatus/icon?job=redwit-dev%2Fgoono-server-ts%2Fdev)](https://jenkins.redwit.io/job/redwit-dev/job/goono-server-ts/job/dev/)
[![Generic badge](https://img.shields.io/badge/version-v3.1.4-green.svg)](https://github.com/redwit-dev/goono-server-ts/releases)

## 1. Outline
### 1.1. Introduction

A repository for the Typescript Backend Server using those libraries:
  - [NestJS](https://nestjs.com): A progressive Node.js framework
  - [Fastify](https://fastify.dev/): Fast and low overhead web framework, for Node.js
  - [Sequelize](https://sequelize.org/): TypeScript and Node.js ORM for database

### 1.2. Directories
This template project has categorized directories like below.

As you can see from the below, all of the TypeScript source files are placed into the [src](src/) directory. When you build the TypeScript source files, compiled files would be placed into the `dist` directory following the [tsconfig.json](tsconfig.json) configuration.

  - [src/](src/): TypeScript Source directory
    - [src/api-server/](src/api-server/): Client SDK that would be published
      - [**src/api-server/activityLog/**](src/api-server/activityLog/): ActivityLog domain service module generated by the [`NestJS`](https://nestjs.com)
      - [**src/api-server/api/**](src/api-server/api/): API functions generated by the [`Fastify`](https://github.com/fastify/fastify)
      - [**src/api-server/auth/**](src/api-server/auth/): Auth login service module
      - [**src/api-server/database/**](src/api-server/database/): Provide domain repositories
      - [**src/api-server/folders/**](src/api-server/folders/): Folder domain service module generated by the [`NestJS`](https://nestjs.com)
      - [**src/api-server/license/**](src/api-server/license/): License domain service module generated by the [`NestJS`](https://nestjs.com)
      - [**src/api-server/notes/**](src/api-server/notes/): Note domain service module generated by the [`NestJS`](https://nestjs.com)
      - [**src/api-server/projects/**](src/api-server/projects/): Project domain service module generated by the [`NestJS`](https://nestjs.com)
      - [**src/api-server/tag/**](src/api-server/tag/): Tag domain service module generated by the [`NestJS`](https://nestjs.com)
      - [**src/api-server/user/**](src/api-server/user/): User domain service module generated by the [`NestJS`](https://nestjs.com)
    - [src/commons/](src/commons/): Bunch of common service concepts
        - [**src/commons/config/**](src/commons/config/): Configuration files for server environment
    - [src/init-database/](src/init-database/): Migration database service
        - [**src/init-database/migration/**](src/init-database/migration/): Version history of migration
    - [src/test-api-server/](src/test-api-server/): Test API services written in [`Fastify`](https://github.com/fastify/fastify)
        - [**src/test-api-server/testSuites/**](src/test-api-server/testSuites/): Test funtions about domain router
    - [src/tests/](src/tests/): Test suites for domain layered architecture
        - [**src/tests/domain/**](src/tests/domain/): Test domain layer that contain core business functions
        - [**src/tests/repositories/**](src/tests/repositories/): Test infrastructure layer that repositories for domain persistence
        - [**src/tests/services/**](src/tests/services/): Test application layer that connects the domain layer and the infrastructure layer
  - [scripts/](scripts/): Linux command collection for set the backend server environment
  - [.env.template](.env.template): Backend server environment template
  - [docker-compose.template.yaml](docker-compose.template.yaml): Docker template about backend server services
  - [package.json](package.json): NPM configuration

## 2. Installation
### 2.1. Docker
Our backend server is optimized for deployment as docker. Therefore, to mount this backend server on your local machine, recommend to install the [`Docker Desktop`](https://www.docker.com/products/docker-desktop/).

### 2.2 Dependency Services
[docker-services](https://github.com/redwit-dev/docker-services) must be installed before installing the server. Redis, Mysql services are mandatory in the local environment and the rest are optional. You can view the list of services of  [docker-services](https://github.com/redwit-dev/docker-services) in the `docker-compose.yaml`.

### 2.3. Repository
Download this project through the git clone command
```bash
# CLONE REPOSITORY
git clone ${REPOSITORY}
```

### 2.4. Set up `.env`
The description of the environment variable setting script can be found at [scripts/README.md](scripts/README.md)

Configure the `.env` file based on the `env.template` file in the initial state of cloning a report.
Go to the repo root path and run the script `init_test_env.sh`. 
```bash
source ./scripts/init_test_env.sh
```
The script results in a `.env` file.


| Variable Name          | Description
|-----------------|----------------------------------------
| ***_HOST |  Accessible interface address, usually using internal network interface and setting rev proxy
| ***_PASSWORD(PW)      | Specific database access password
| ***_USER_NAME(USER)       | Database user name
| ***_SCALE      | The size of the service to be created as a container.
| TEST_ENABLED   | Signals for the development environment
| PRIV_KEY_PW   | Private server key for accessing `Crypto` service

### 2.5. Set up service
Finally, Using the generated `.env` as a guide, generate a docker composite file with docker container specifications defined for each service.
Go to the repo root path and run the script `update_compose.sh`. 
```bash
source ./update_compose.sh
```
The script results in a `docker-compose.yaml` file.

## 3. Deploy
Deploy the service specified in the `docker-compose.yaml` file.
```bash
# If skip the service name, it build all services
docker compose up --build -d ${service name}
```

You can view the deployed services in the Docker desktop UI.

## 4. Appendix
### 4.1. NPM Run Commands
List of the run commands defined in the [package.json](package.json) are like below:
  - `build`: Compile the source code
    - `build:nest`: Compiles an application or workspace into an output folder with tsc option
  - `prebuild`: Clear the dist root
  - `prepare`: Execute auto build tsconfig & eslintrc rules
  - `start`: Start the backend server
    - `npm run start:dev`
    - `npm run start:debug`
  - `test`: Execute the tests with jest
    - `npm run test:watch`
    - `npm run test:cov`
    - `npm run test:e2e`
    - `npm run test:api`
  - `token`: Make Bearer token for api testing with post-man
  - `api-server`: Deploy the api service
  - `test-api-server`: Excute the tests built on fastify
  - `init-database`: Schema-based database migration
  - `format`: Formatting the `.ts` files with prettier
    - `format:test`: Formatting the `.ts` files in tests directory
  - `worker`: Deploy the external service
    - `pdf-worker`: Build note to pdf
    - `note-worker`: Register file to note
    - `auth-worker`: Encrypt the note
    - `hlf-worker`: Register note to block-chain
    - `gfile-worker`: Register google-drive file to note
    - `maintenance-worker`: Sync for failed register note
    - `notification-worker`: Send notification to device
    - `schedule-worker`: Scheduler for notification
    - `github-worker`: Register git repository actions to note
    - `email-worker`: Send email to users

### 5.2. Related Repositories
> [goono-commons](https://github.com/redwit-dev/goono-commons): Goono submodule that defines promised schemas when communicating with goono web service
[redwit-commons](https://github.com/redwit-dev/redwit-commons): Redwit submodule that defines the utility functions commonly used in Redwit services
[redwit-server-commons](https://github.com/redwit-dev/redwit-server-commons): Redwit submodule that defines the utility functions commonly used in Redwit server